# 1、聚合如何优化？

https://elasticsearch.cn/question/6323

【回复】

Agg1 推荐添加上  "collect_mode" : "breadth_first"    表示广度优先
Agg2 添加上  "min_doc_count": 10   限制最小文档个数，这样就可以去掉 orderCount 这个聚合了


这个聚合最大的问题是agg2的size设置得很大，估计keyword5字段的基数非常高，却期望返回所有聚合结果。  
如果该字段基数真的有上亿，加上第一层聚合还有24的size，组合产生的buckets数量可能在数亿 至数十亿的量级，计算产生的内存压力也非常大，速度很难快起来。
 
采用@rochy 的建议，aggs2添加"min_doc_count":10这个设置，应该会大大减少buckets的数量。
要注意的是，如果count>10的buckets数量依然很大， 聚合的速度还是快不起来。 返回海量buckets的内存开销无法避免，
并且因为消耗内存过多，容易给结点带来很大的GC压力，甚至OOM。 如果单次聚合取回结果困难，可以考虑将聚合分成多个批次分别取回。

# 2、【性能】单次查询时间几十ms,并发数提高的情况下，查询速度如何提升
集群状态：3个EsMaster安装在三台机器节点上。
                 另外两台机器：分片安装了5个EsNode，每个实例内存均为25G，机器内存256G
                 ES 6.1.3版本
 
目前将数据存储在HBASE，将rowkey信息存储在ES中
 
查询单个索引，4亿条数据，30shard，单次查询时间在几十ms内
 
并发3000时速度能稳定在1s内
 
并发6000时查询速度2-3S，查询的过程中堆内存使用率正常
 
对于这种高并发的查询场景有没有优化的空间和思路，还有如何判断查询是否已经到达瓶颈状态、、

【回复】

如果是追求极致的搜索响应速度和搜索并发量， 不应该做单机上的多实例部署，单个ES实例足够利用所有的硬件资源了。

你只有两台机器用作数据结点，所以初步有以下建议:
1. 每台机器只安装一个ES node
2. 适当`减少索引的分片数量`，4亿数据，30个shard有些多了，搜索合并阶段的负载可能过重，减少到10个shard甚至4个shard，对比测试一下。
 
判断是否达到瓶颈，首先要监控search线程池的活动状况，queue是否一直很高，reject是否很高。
然后配合jvm gc情况，系统基础指标，cpu , io使用情况，判断瓶颈在那里。

# 3、es6.x如何获取所有的聚合结果


es2.x版本中，在聚合查询时，通过设置setSize(0)就可以获取所有的聚合结果，
但是在6.x版本好像去掉了这个功能，请问大神我现在需要通过聚合来获取所有的聚合结果，如何实现呢？

ES 2.X 设置为 0 等效于设置为 Integer.MAX_VALUE；
你想获取全部就设置 size 为 Integer.MAX_VALUE 即可

性能问题，铭毅不建议这么操作。

# 4、elasticsearch 指定缺省的分析器

https://elasticsearch.cn/question/6310


```
{
  "settings": {
    "analysis": {
      "analyzer": {
        "default": {
          "type": "ik_max_word",
          "tokenizer": "ik_max_word"
        }
      }
    }
  }
}
```

# 5、 elasticsearch去除相似度较高的数据

https://elasticsearch.cn/question/6305

假设有这样一组数据
title:1-6月份房地产市场运行情况
title:1-7月份房地产市场运行情况 
title:1-10月份房地产市场运行情况 
标题非常类似的数据,只显示一条

【方案】
冗余文档去重，在入索引库前做，不然在召回后的去重不仅难以控制召回集里冗余文档的数量，重排前的去冗余都会非常耗时。
业务层面必然会碰到的问题，我的经验是文档入库前```spark算文档的simhash```，建立一个冗余库，
业务文档索引库只存在一篇“原创”文档，通过UI端提供相似文档按钮召回冗余库里的相似文档即可。

思路2：

去除相似度高的应该在数据录入的时候进行处理
你现在的需求就造成无法定义相似度高，
此外相似度高的显示那一条数据呢？

你这个最好是使用 ES 查询，然后自己程序里面进行判断
相似度你可以使用 编辑距离、余弦距离等方式来进行判定。
